<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>phpdbg for fun and profit</title>

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="reveal.js/css/reveal.css">
		<link rel="stylesheet" href="reveal.js/css/theme/sky.css" id="theme">

		<!-- CSS overrides -->
		<link rel="stylesheet" href="css/style.css">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="reveal.js/lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="reveal.js/lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<div class="slides">
				<section id="title">
					<h1><code>phpdbg</code> for fun and profit</h1>
					<h3>Adam Harvey</h3>
					<h3><a href="https://twitter.com/LGnome">@LGnome</a></h3>
				</section>

				<section data-background="images/what.jpg">
					<section id="what-is-the-what">
						<aside class="notes">
							So let's start with the basics. What <em>is</em> phpdbg?
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="cli-debugger">
						<h2>Command line debugger</h2>
						<aside class="notes">
							It's a command line debugger, like gdb or lldb. It was originally
							written by Joe Watkins and Felipe Pena, and has also seen
							significant input from Bob Weinand.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="cli-debugging-example">
						<code class="terminal">aharvey@aharvey-mbp:/tmp$ phpdbg code/fizzbuzz.php
<span class="green">[Welcome to phpdbg, the interactive PHP debugger, v0.5.0]</span>
To get help using phpdbg type "help" and press enter
<span class="green">[Please report bugs to &lt;http://bugs.php.net/report.php&gt;]
[Successful compilation of /tmp/code/fizzbuzz.php]</span>
prompt&gt; break fizzbuzz
<span class="green">[Breakpoint #0 added at fizzbuzz]</span>
prompt&gt; run 15
<span class="green">[Breakpoint #0 at /tmp/code/fizzbuzz.php:3, hits: 1]</span>
&gt;00003:   if (0 == ($n % 3)) {
 00004:     return 'Fizz';
 00005:   } elseif (0 == ($n % 5)) {
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							Practically, that means that you control it via commands in the
							terminal, like so. This is an example that we'll walk through in
							a few minutes.
						</aside>
					</section>

					<section id="not-xdebug" data-background="images/terminal.jpg">
						<aside class="notes">
							This does mean that your script is not running in a Web server
							like XDebug, and your output isn't going to go to a browser.
							We'll talk about that later.
						</aside>
					</section>
				</section>

				<section data-background="images/delivery.jpg">
					<section id="getting-phpdbg">
						<aside class="notes">
							Let's talk about getting phpdbg. Unlike XDebug and most other
							debugging and profiling tools for PHP, it's not an extension, but
							rather a different SAPI. (Explain SAPIs.)
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="debian-ubuntu">
						<h2>Debian and Ubuntu</h2>
						<pre><code class="sh" data-trim>
apt-get install php5-phpdbg
apt-get install php7.0-phpdbg
						</code></pre>
						<aside class="notes">
							On Debian and Ubuntu, there are packages available in recent
							versions: in practice, that means Vivid, Wily and Xenial for
							Ubuntu and Jessie for Debian.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="rhel-centos">
						<h2>Red Hat and CentOS</h2>
						<pre><code class="sh" data-trim>
yum install php56-php-dbg
yum install php70-php-dbg
dnf install php-dbg
						</code></pre>
						<aside class="notes">
							On RHEL 5-7, Remi's repo includes phpdbg for PHP 5.6 or 7.0.
							Recent versions of Fedora include phpdbg as well. Note that you
							can't search for phpdbg.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="osx">
						<h2>Mac OS X</h2>
						<pre><code class="sh" data-trim>
brew tap homebrew/php
brew install php70 --with-phpdbg
						</code></pre>
						<aside class="notes">
							The Homebrew PHP tap includes phpdbg packages for PHP 5.4 and
							later. MAMP&hellip; well, don't use MAMP.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="source">
						<h2>From source</h2>
						<pre><code class="sh" data-trim>
./configure --enable-phpdbg
						</code></pre>
						<aside class="notes">
							Finally, if you're building from source (good for you!), it's
							bundled from PHP 5.6. You just need to add one switch to
							configure on PHP 5.6. On PHP 7.0, you'll get phpdbg by default.
						</aside>
					</section>
				</section>

				<section data-background="images/instructions.jpg">
					<section id="using-phpdbg">
						<aside class="notes">
							Let's look at how to use phpdbg, starting with how to start it.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="startup">
						<code class="terminal">aharvey@aharvey-mbp:/tmp$ phpdbg code/fizzbuzz.php
<span class="green">[Welcome to phpdbg, the interactive PHP debugger, v0.5.0]</span>
To get help using phpdbg type "help" and press enter
<span class="green">[Please report bugs to &lt;http://bugs.php.net/report.php&gt;]
[Successful compilation of /tmp/code/fizzbuzz.php]</span>
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							We saw this in screenshot form briefly earlier. Like PHP CLI, we
							provide a file name. (You don't have to, but I like to.) However,
							instead of starting the script immediately, phpdbg just starts
							the Zend Engine and gives us a prompt. Help will give us&hellip;
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="help">
						<code class="terminal" style="font-size: 0.3em">prompt&gt; help

<strong>phpdbg</strong> is a lightweight, powerful and easy to use debugging
platform for PHP5.4+
It supports the following commands:

<strong>Information</strong>
  <strong>list</strong>     list PHP source
  <strong>info</strong>     displays information on the debug session
  <strong>print</strong>    show opcodes
  <strong>frame</strong>    select a stack frame and print a stack frame summary
  <strong>back</strong>     shows the current backtrace
  <strong>help</strong>     provide help on a topic

<strong>Starting and Stopping Execution</strong>
  <strong>exec</strong>     set execution context
  <strong>run</strong>      attempt execution
  <strong>step</strong>     continue execution until other line is reached
  <strong>continue</strong> continue execution
  <strong>until</strong>    continue execution up to the given location
  <strong>next</strong>     continue execution up to the given location and halt on the first line after it
  <strong>finish</strong>   continue up to end of the current execution frame
  <strong>leave</strong>    continue up to end of the current execution frame and halt after the calling instruction
  <strong>break</strong>    set a breakpoint at the specified target
  <strong>watch</strong>    set a watchpoint on $variable
  <strong>clear</strong>    clear one or all breakpoints
  <strong>clean</strong>    clean the execution environment

<strong>Miscellaneous</strong>
  <strong>set</strong>      set the phpdbg configuration
  <strong>source</strong>   execute a phpdbginit script
  <strong>register</strong> register a phpdbginit function as a command alias
  <strong>sh</strong>       shell a command
  <strong>ev</strong>       evaluate some code
  <strong>quit</strong>     exit phpdbg

Type <strong>help &lt;command&gt;</strong> or (<strong>help alias</strong>) to get detailed help on any of the above commands, for example <strong>help list</strong> or <strong>h l</strong> Note that help will also match partial commands if unique (and list out options if not unique), so <strong>help clea</strong> will give help on the <strong>clean</strong> command, but <strong>help cl</strong> will list the summary for <strong>clean</strong> and <strong>clear</strong>.  

Type <strong>help aliases</strong> to show a full alias list, including any registered phpdginit functions
Type <strong>help syntax</strong> for a general introduction to the command syntax.
Type <strong>help options</strong> for a list of phpdbg command line options.
Type <strong>help phpdbginit</strong> to show how to customise the debugger environment.</code>
						<aside class="notes">
							Ack! Don't worry. You don't need to read it now, and it's not
							that bad. I'm not going to cover everything, but I'm going to
							cover the immediately useful stuff through a couple of examples.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="run">
						<code class="terminal" style="font-size: 0.8em">prompt&gt; help run
Command: <strong>run</strong>  Alias: <strong>r  attempt execution</strong>

Enter the vm, starting execution. Execution will then continue until the next
breakpoint or completion of the script. Add parameters you want to use as $argv

<strong>Examples</strong>

    prompt&gt;  run
    prompt&gt;  r
    Will cause execution of the context, if it is set

    prompt&gt;  r test
    Will execute with $argv[1] == "test"

Note that the execution context must be set. If not previously compiled, then
the script will be compiled before execution.

Note that attempting to run a script that is already executing will result in
an "execution in progress" error.
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							To start with: let's look at run. Again, there's a bit too much
							for a slide, but what I want to point out is the overall
							structure: each command has online help that includes its
							aliases, what it does, and examples. Let's look at each part in
							turn. (I won't do this for all the commands, but it's important
							to know how to read the help.)
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="run-description">
						<code class="terminal">prompt&gt; help run
Command: <strong>run</strong>  Alias: <strong>r  attempt execution</strong>

Enter the vm, starting execution. Execution will then
continue until the next breakpoint or completion of the
script. Add parameters you want to use as $argv</code>
						<aside class="notes">
							This tells us that the command can also be called with a straight
							"r", or "attempt execution", and then describes what it does.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="run-examples">
						<code class="terminal"><strong>Examples</strong>

    prompt&gt;  run
    prompt&gt;  r
    Will cause execution of the context, if it is set

    prompt&gt;  r test
    Will execute with $argv[1] == "test"</code>
						<aside class="notes">
							Here are the examples. Note that this command takes optional
							arguments: in this case, "test" is the same as running "php
							fizzbuzz.php test".
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="run-notes">
						<code class="terminal">Note that the execution context must be set. If not
previously compiled, then the script will be compiled
before execution.

Note that attempting to run a script that is already
executing will result in an "execution in progress" error.</code>
						<aside class="notes">
							Finally, we have some general notes. The execution context is the
							file that's the entry point. And we can't run a script if another
							script is executing, which is pretty common sense.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="run-it">
						<code class="terminal">prompt&gt; run 15</code>
						<aside class="notes">
							The script that I loaded is a FizzBuzz implementation, and it
							takes the maximum number as an argument. So let's run it.
							(FizzBuzz: divisible by 3 is Fizz; by 5 is Buzz; by both is
							FizzBuzz.)
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="ran-it">
						<code class="terminal">prompt&gt; run 15
1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 Fizz
<span class="green">[Script ended normally]</span>
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							Two things. Firstly, you can see that we got output, and then it
							ended. Secondly, I've committed one of the classic blunders, and
							I'm not talking about starting a land war in Asia. See that last
							"Fizz"?
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="fizz">
						<pre><code class="php" data-trim style="font-size: 2em">
function fizzbuzz(int $n): string {
  if (0 == ($n % 3)) {
    return 'Fizz';
  } elseif (0 == ($n % 5)) {
    return 'Buzz';
  }
  return (string) $n;
}

foreach (range(1, (int) $_SERVER['argv'][1]) as $n) {
  echo fizzbuzz($n).' ';
}
echo "\n";
						</code></pre>
						<aside class="notes">
							Here's my script. The bug is very obvious, but let's see how we'd
							attack this with a debugger. We know that we call fizzbuzz() for
							each number, and we know that the output for 15 seems wrong.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="breakpoints">
						<code class="terminal">prompt&gt; help break
Command: <strong>break</strong>  Alias: <strong>b  set breakpoint</strong>

Breakpoints can be set at a range of targets within the
execution environment.  Execution will be paused if the
program flow hits a breakpoint.</code>
						<aside class="notes">
							As those of you who've used debuggers before know, the biggest
							single tool you have is breakpoints. Effectively, you're going to
							tell the runtime to stop when a certain condition is met. In
							traditional debuggers, that's usually when execution hits a
							particular line, or a particular function. phpdbg has a break
							command that sets a breakpoint.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="basic-breakpoints">
						<code class="terminal">prompt&gt; break 3
<span class="green">[Breakpoint #0 added at /tmp/code/fizzbuzz.php:3]</span>
prompt&gt; break fizzbuzz.php:3
<span class="green">[Breakpoint #0 added at /tmp/code/fizzbuzz.php:3]</span>
prompt&gt; break fizzbuzz
<span class="green">[Breakpoint #1 added at fizzbuzz]</span></code>
						<aside class="notes">
							The basics are well, basic. You can set a breakpoint on a line
							alone (for the current file), a file and line (phpdbg is smart
							enough in this case to know it's the same one), or a function.
							"help break" covers the full range of syntax options: methods are
							also included.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="what-is-broken-may-never-die">
						<code class="terminal">prompt&gt; run 15
<span class="green">[Breakpoint #0 at /tmp/code/fizzbuzz.php:3, hits: 1]</span>
&gt;00003:   if (0 == ($n % 3)) {
 00004:     return 'Fizz';
 00005:   } elseif (0 == ($n % 5)) {
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							With our newly set breakpoints, let's run the script! And, of
							course, it breaks right away, since we enter fizzbuzz() each time
							we have a value. We get this helpful source display, and we
							presumably want to know what $n is.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="eval-is-evil">
						<code class="terminal">prompt&gt; help ev
Command: <strong>ev</strong>  Alias:
The <strong>ev</strong> command takes a string expression which it evaluates
and then displays. It evaluates in the context of the
lowest (that is the executing) frame, unless this has
first been explicitly changed by issuing a frame command.</code>
						<aside class="notes">
							phpdbg lets us evaluate code, which can be as simple as
							evaluating a variable. The nifty thing is that it evaluates it in
							the current context, so we can evaluate $n, even though it's a
							local variable.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="one-potato">
						<code class="terminal">prompt&gt; ev $n
1
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							OK, $n is 1. We're pretty sure that works. We can tell the script
							to continue.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="two-potato">
						<code class="terminal">prompt&gt; continue
1
<span class="green">[Breakpoint #0 at /tmp/code/fizzbuzz.php:3, hits: 2]</span>
&gt;00003:   if (0 == ($n % 3)) {
 00004:     return 'Fizz';
 00005:   } elseif (0 == ($n % 5)) {
prompt&gt; ev $n
2
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							We continue. (The continue command resumes execution.) We see a
							"1", which is output from the script, then we break again. This
							time $n is 2. We're pretty sure that's OK too. Hmmm. Let's go
							back to the breakpoint help.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="what-else-you-got">
						<code class="terminal"><strong>Examples</strong>
						
    prompt&gt;  break at phpdbg::isGreat if $opt == 'S'
    prompt&gt;  break @ phpdbg::isGreat if $opt == 'S'
    Break at any opcode in phpdbg::isGreat when the
condition ($opt == 'S') is true</code>
						<aside class="notes">
							There are many, many examples, but this one catches my eye. We
							know we're interested in fizzbuzz(), and we know we're interested
							only really in a special case: when $n is 15.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="conditional-breakpoints">
						<code class="terminal">prompt&gt; break del 0
<span class="green">[Deleted breakpoint #0]</span>
prompt&gt; break at fizzbuzz if $n == 15
<span class="green">[Conditional breakpoint #1 added $n == 15/0x10a668300]</span>
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							Let's change it up a little. We'll delete our original
							breakpoint, and set a new, conditional breakpoint that only
							triggers when we enter fizzbuzz() and $n is 15. (That can be any
							valid PHP expression.)
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="case-15">
						<code class="terminal">prompt&gt; continue
2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14
<span class="green">[Conditional breakpoint #1: at fizzbuzz if $n == 15 at
/tmp/code/fizzbuzz.php:3, hits: 1]</span>
&gt;00003:   if (0 == ($n % 3)) {
 00004:     return 'Fizz';
 00005:   } elseif (0 == ($n % 5)) {
prompt&gt; ev $n
15
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							And here we are! This is the case we care about. From here, we
							don't want to just continue, but we want to step through the
							code.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="step">
						<code class="terminal">prompt&gt; help step
Command: <strong>step</strong>  Alias: <strong>s  step through execution</strong>

Execute opcodes until next line

<strong>Examples</strong>

    prompt&gt;  s
    Will continue and break again in the next encountered
line</code>
						<aside class="notes">
							Again, like pretty much every debugger ever, phpdbg has a step
							command. It just continues execution until the next line.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="cut-a-hole-in-the-box">
						<code class="terminal">prompt&gt; step
<span class="green">[L3          0x10a67a040 IS_EQUAL                0                    ~0                   ~1                   /tmp/code/fizzbuzz.php]
[Conditional breakpoint #1: at fizzbuzz if $n == 15 at /tmp/code/fizzbuzz.php:3, hits: 2]</span>
&gt;00003:   if (0 == ($n % 3)) {
 00004:     return 'Fizz';
 00005:   } elseif (0 == ($n % 5)) {
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							Now we're actually executing the line we broke on. There's the
							opcode that's being executed last on that line (there's also a
							MOD, but that's happened by this point) and where we are.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="code-of-conduct-prevents-me-from-including-this-joke">
						<code class="terminal">prompt&gt; step
<span class="green">[L4          0x10a67a080 RETURN                  "Fizz"                                                         /tmp/code/fizzbuzz.php]</span>
&gt;00004:     return 'Fizz';
 00005:   } elseif (0 == ($n % 5)) {
 00006:     return 'Buzz';
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							Step again, and we see the problem. We're about to return, and
							we're just returning "Fizz", not "FizzBuzz". Well, shit.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="profit">
						<code class="terminal">prompt&gt; step
<span class="green">[L12         0x10a6801c0 CONCAT                  @6                   " "                  ~7                   /tmp/code/fizzbuzz.php]</span>
&gt;00012:   echo fizzbuzz($n).' ';
 00013: }
 00014: echo "\n";
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							If we step again, we see we're indeed back out of the function,
							and we returned the wrong thing. Guess we should add a mod 15
							case, eh?
						</aside>
					</section>
				</section>

				<section data-background="images/danger.jpg">
					<section id="exceptions">
						<aside class="notes">
							Before we move onto a slightly more involved example, here's
							another case where phpdbg will stop execution: exceptions.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="no-exception-handler">
						<pre><code class="php" data-trim>
class TableFlipException extends Exception {}

function （╯°□°）╯︵ ┻━┻() {
  throw new TableFlipException('ruh roh');
}

（╯°□°）╯︵ ┻━┻();
						</code></pre>
						<aside class="notes">
							Here's our sample code, which Sara kindly turned into a Packagist
							package yesterday. We'll throw an exception, and there's no
							try-catch or exception handler.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="exceptional">
						<code class="terminal">aharvey@aharvey-mbp:/tmp$ phpdbg code/exception.php
<span class="green">[Welcome to phpdbg, the interactive PHP debugger, v0.5.0]</span>
To get help using phpdbg type "help" and press enter
<span class="green">[Please report bugs to &lt;http://bugs.php.net/report.php&gt;]</span>
<span class="green">[Successful compilation of /tmp/code/exception.php]</span>
prompt&gt; r
<span class="red">[Uncaught TableFlipException in /tmp/code/exception.php on line 5: ruh roh]</span>
&gt;00005:   throw new TableFlipException('ruh roh');
 00006: }
 00007:
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							The nice thing here is that phpdbg goes back to the point where
							the exception is thrown.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="exception-handler">
						<pre><code class="php" data-trim>
class TableFlipException extends Exception {}

function （╯°□°）╯︵ ┻━┻() {
  throw new TableFlipException('ruh roh');
}

set_exception_handler(function ($e) { echo $e; });

（╯°□°）╯︵ ┻━┻();
						</code></pre>
						<aside class="notes">
							The really useful (and interesting) part is that this still works
							even if you have an exception handler installed. It won't stop if
							you have a catch block, but if it makes it all the way to the
							exception handler, phpdbg will stop. That's fine, as long as you
							don't use exceptions for flow control, right?
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="heres-the-proof-fully-ablaze">
						<code class="terminal">aharvey@aharvey-mbp:/tmp$ phpdbg code/exception.php
<span class="green">[Welcome to phpdbg, the interactive PHP debugger, v0.5.0]</span>
To get help using phpdbg type "help" and press enter
<span class="green">[Please report bugs to &lt;http://bugs.php.net/report.php&gt;]</span>
<span class="green">[Successful compilation of /tmp/code/exception.php]</span>
prompt&gt; r
<span class="red">[Uncaught TableFlipException in /tmp/code/exception.php on line 5: ruh roh]</span>
&gt;00005:   throw new TableFlipException('ruh roh');
 00006: }
 00007:
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							Here's the proof. Execution still stops at the same point, even
							though there's an exception handler that will eventually take
							care of this.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="opcodes">
						<pre><code class="php" data-trim>
function （╯°□°）╯︵ ┻━┻() {
  throw new TableFlipException('ruh roh');
}
						</code></pre>
						<code class="terminal">prompt&gt; print
<span class="green">[Stack in （╯°□°）╯︵ ┻━┻() (5 ops)]</span>
L4-6 （╯°□°）╯︵ ┻━┻() /Users/aharvey/Trees/phpdbg-for-fun-and-profit/code/exception.php - 0x11206e180 + 5 ops
 L5  #0  NEW          "TableFlipException"        @0
 L5  #1  SEND_VAL_EX  "ruh roh"             1
 L5  #2  DO_FCALL
 L5  #3  THROW        @0
 L6  #4  RETURN       null
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							On a tangent, you can also get phpdbg to show you the actual
							opcodes for the context you're currently in. The table flipping
							function is a good one to look at, because you can see how this
							maps. Why is this important? Firstly, you can have phpdbg work by
							opcode instead of line. Secondly&hellip; well, you'll see.
						</aside>
					</section>
				</section>

				<section data-background="images/sparrow.jpg">
					<section id="too-real">
						<aside class="notes">
							Let's look at a more real example.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="phptek-tweeps">
						<h2>
							<a href="https://github.com/LawnGnome/phptek-tweeps">
								<span class="octicon octicon-mark-github"></span>
								<code>LawnGnome/phptek-tweeps</code>
							</a>
						</h2>
						<aside class="notes">
							Here is a project called phptek/tweeps. It's on GitHub! It's
							written in Laravel! It uses façades! It must be good, right?
							Basically, this allows me to scrape the accounts and user names
							of people who tweet about #phptek because REASONS.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="insert-evil-laugh-here">
						<code class="terminal">root@57d38b20b3cb:/src# ./artisan tweeps:update
Setting the name of SandyS1 to Sandy Smith
Setting the name of phparch to php[architect]
Setting the name of glasnt to Katie McLaughlin
Setting the name of enygma to Chris Cornutt
Setting the name of nomadphp to Nomad PHP
Setting the name of ramsey to Ben Ramsey
Setting the name of LGnome to Adam Harvey
Setting the name of asgrim to Asgrimy McAsgrimface

Muahahahahaha!</code>
						<aside class="notes">
							Obviously, this needs to monitor the search, so I've written an
							Artisan command that does just that. It looks like this. This is
							actual output, folks. Be afraid.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="my-precious-evil-plan">
						<code class="terminal">root@57d38b20b3cb:/src# ./artisan tweeps:update
Setting the name of developerjack to Jack Skinner'; --...

<div class="red-background">
  [Illuminate\Database\QueryException]
  SQLSTATE[42000]: Syntax error or access violation: 1064
   You have an error in your SQL syntax; check the manual
   that corresponds to your MariaDB server version for th
  e right syntax to use near '; --')' at line 1 (SQL: REP
  LACE INTO tweeps (account, name) VALUES ('developerjack
  ', 'Jack Skinner'; --'))

</div></code>
						<aside class="notes">
							However, then it started breaking. That's not good. Note that,
							while artisan actually outputs two exceptions here (I've omitted
							the second one for brevity), neither of them actually tell you
							where the exception occurred.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="phpdbg-to-the-rescue">
						<code class="terminal">root@57d38b20b3cb:/src# phpdbg artisan
<span class="green">[Welcome to phpdbg, the interactive PHP debugger, v0.5.0]</span>
To get help using phpdbg type "help" and press enter
<span class="green">[Please report bugs to &lt;http://bugs.php.net/report.php&gt;]</span>
<span class="green">[Successful compilation of /src/artisan]</span>
prompt&gt; run tweeps:update
Setting the name of developerjack to Jack Skinner'; --...

<div class="red-background">[Illuminate\Database\QueryException]
	...
</div>
<span class="green">[Script ended normally]</span>
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							phpdbg to the rescue? Let's see. Well, that wasn't helpful. The
							problem is that the exception is being caught, so we still have
							no idea how to figure out where it's coming from. Aargh!
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="break-what-now">
						<code class="terminal">    prompt&gt;  break ZEND_ADD
    prompt&gt;  b ZEND_ADD
    Break on any occurrence of the opcode ZEND_ADD</code>
						<aside class="notes">
							Let's delve back into the breakpoint help. Conditional
							breakpoints were cool. Maybe there's something else. And lo and
							behold, we find this! Adds aren't cool, but you know what is
							cool?
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="throw">
						<pre><code class="c" data-trim>
#define ZEND_THROW                           108
						</code></pre>
						<aside class="notes">
							(Sorry, I am contractually required to have at least one slide of
							C in each talk.) Remember those opcodes we saw a few slides back?
							There's a THROW opcode! ZEND_THROW is the opcode used when an
							exception is being thrown. So let's try breaking on that.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="break-throw">
						<code class="terminal">prompt&gt; break ZEND_THROW
<span class="green">[Breakpoint #0 added at ZEND_THROW]</span>
prompt&gt; run tweeps:update
Setting the name of developerjack to Jack Skinner'; --...
<span class="green">[Breakpoint #0 in ZEND_THROW at /src/vendor/laravel/framework/src/Illuminate/Database/Connection.php:714, hits: 1]</span>
 00713:             throw new QueryException(
&gt;00714:                 $query, $this-&gt;prepareBindings($bindings), $e
 00715:             );
 00716:         }
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							Success! We're now at the point the exception is thrown. (I've
							included the previous line just for context.) Unfortunately, it's
							pretty deep in Laravel. So let's now look at the last piece of
							the debugger puzzle: the stack trace.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="help-back">
						<code class="terminal">prompt&gt; help back
Command: <strong>back</strong>  Alias: <strong>t  show trace</strong>

Provide a formatted backtrace using the standard
debug_backtrace() functionality.  An optional unsigned
integer argument specifying the maximum number of frames
to be traced; if omitted then a complete backtrace is
given.</code>
						<aside class="notes">
							Here's the help for the back command, which prints the current
							stack trace.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="backtrace">
						<code class="terminal">prompt&gt; back
...
frame #5: App\Console\Commands\UpdateTweeps-&gt;updateTweep(account="developerjack", name="Jack Skinner'; --") at /src/app/Console/Commands/UpdateTweeps.php:62
...
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							The stack trace is 16 frames deep at this point, but here's the
							first one that's not a function in a vendor directory. Now, we
							could just look at the code, but we can actually switch to that
							frame and examine its local variables with the frame command.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="help-frame">
						<code class="terminal">prompt&gt; help frame
Command: <strong>frame</strong>  Alias: <strong>f  switch to a frame</strong>

The <strong>frame</strong> takes an optional integer argument. If omitted,
then the current frame is displayed If specified then the
current scope is set to the corresponding frame listed in
a <strong>back</strong> trace. This can be used to allowing access to the
variables in a higher stack frame than that currently
being executed.</code>
						<aside class="notes">
							Here's the frame command. In our case, we know that it's frame 5,
							so let's do that.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="frame-5">
						<code class="terminal">prompt&gt; frame 5
<span class="green">[Switched to frame #5]</span>
&gt;00062:         DB::statement("REPLACE INTO tweeps (account, name) VALUES ('$account', '$name')");
 00063:     }
 00064: }
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							Here's the updateTweep() method. Ah. That doesn't look like best
							practice.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="he-is-living-comfort-eagle">
						<code class="terminal">prompt&gt; ev $name
Jack Skinner'; --
prompt&gt; ev $_ = "REPLACE INTO tweeps (account, name) VALUES ('$account', '$name')"
REPLACE INTO tweeps (account, name) VALUES ('developerjack', 'Jack Skinner'; --')
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							Let's look at the local $name and evaluate the string just to
							confirm our suspicions. (The awkward $_ is because of a
							limitation in phpdbg's command parser: a double quote straight
							after a command is assumed to be a parameter delimiter, and isn't
							passed to ev.)
							<br>
							Little Bobby Tables&hellip; er, developerjack teaches us once
							again that parameterised queries are a good thing. (Sorry,
							Colin.)
						</aside>
					</section>
				</section>

				<section data-background="images/web.jpg">
					<section id="web">
						<aside class="notes">
							All that's good, but most of us spend more time on web sites than
							CLI scripts. (Sorry, Cal.) How can we deal with that?
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="fake-plastic-trees">
						<pre><code class="php" data-trim>
$_SERVER = [
  'HTTP_HOST' =&gt; 'localhost',
  'HTTP_ACCEPT' =&gt; '...',
  ...
];
$_GET = [];
$_REQUEST = [];
$_POST = [];
$_COOKIE = [];
$_FILES = [];
chdir('public'); include 'index.php';
						</code></pre>
						<a href="http://phpdbg.com/docs/mocking-webserver">Source: http://phpdbg.com/docs/mocking-webserver</a>
						<aside class="notes">
							The only viable approach today, and the one recommended by the
							phpdbg documentation is to fake the superglobals to look like a
							Web request.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="fake-request">
						<h2>
							<a href="https://github.com/LawnGnome/phpdbg-fake-request">
								<span class="octicon octicon-mark-github"></span>
								<code>LawnGnome/phpdbg-fake-request</code>
							</a>
							<br>
							<a href="https://packagist.org/packages/lawngnome/phpdbg-fake-request">
								<img class="inline" src="images/packagist.png" alt="Packagist">
								<code>lawngnome/phpdbg-fake-request</code>
							</a>
						</h2>
						<aside class="notes">
							For convenience's sake, I've bundled this approach into a script
							and accompanying library that you can install from Packagist.
							It's rough, and PHP 7.0 only, but it works.
						</aside>
					</section>

					<section id="web-example" data-background="images/page1.png">
						<aside class="notes">
							Let's look at the web interface for the phptek tweeps
							application. It can't be as bad as the artisan command, right?
							Page one looks good. Lots of cool people there. Let's go to page
							two&hellip;
						</aside>
					</section>

					<section id="page2" data-background="images/page2.png">
						<aside class="notes">
							Hmmm. Let's zoom in&hellip;
						</aside>
					</section>

					<section id="hax0r" data-background="images/page2.png">
						<img src="images/page2-zoomed.png" alt="I PWNED U NOOB LOLX0RZ">
						<aside class="notes">
							Ah.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="html">
						<pre><code class="html" data-trim>
&lt;tr&gt;
&lt;td&gt;nefarioushax0r&lt;/td&gt;
&lt;td&gt;&lt;script&gt;alert("I PWNED U NOOB LOLX0RZ")&lt;/script&gt;&lt;/td&gt;
&lt;/tr&gt;
						</code></pre>
						<aside class="notes">
							Here's an excerpt from the HTML. Well, there's your problem. But
							how's the script tag ending up in the HTML in the first place?
							phpdbg to the rescue!
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="url">
						<h2><code>http://127.0.0.1:9000/?page=2</code></h2>
						<aside class="notes">
							Since this is a web page, we need to attack this differently.
							First, here's the URL in question. We can't just feed this to
							phpdbg without a wrapper, since this behaviour only occurs on the
							second page, which we can only get to with a get variable.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="starting-fake-request">
						<code class="terminal">root@57d38b20b3cb:/src# phpdbg ./vendor/bin/fake-request GET / public/index.php -g page=2
<span class="green">[Welcome to phpdbg, the interactive PHP debugger, v0.5.0]</span>
To get help using phpdbg type "help" and press enter
<span class="green">[Please report bugs to &lt;http://bugs.php.net/report.php&gt;]</span>
<span class="green">[Successful compilation of /src/vendor/lawngnome/phpdbg-fake-request/bin/fake-request]</span>
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							We'll start up the fake-request script. (The phpdbg is optional,
							since the shebang also includes phpdbg.) So far, so normal, but
							note that we've provided the request method, action, entry point
							and get variable on the command line.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="wheres-the-break">
						<code class="terminal">prompt&gt; break routes.php:15
<span class="green">[Pending breakpoint #0 added at routes.php:15]</span>
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							The question is where to stop execution. In this case, I've added
							a break point at the first line of the anonymous function that's
							the controller. Seems reasonable, since we know it's not the
							framework. It's pending because that file hasn't been loaded yet,
							but that's OK. phpdbg is smart enough to wait for it to be
							included.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="getting-warmer">
						<code class="terminal">prompt&gt; run
<span class="green">[Breakpoint #0 at /src/app/Http/routes.php:15, hits: 1]</span>
&gt;00015:     $tweeps = DB::table('tweeps')-&gt;paginate(30);
 00016:     ob_start();
 00017:
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							OK, we're in. We can use the list command to examine the
							function, but I'm going to just show you the highlights on the
							next slide. (List is also probably the most awkward command in
							phpdbg. In practice, I'd probably just open it up in an editor
							tiled alongside.)
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="da-controller">
						<pre><code class="" data-trim>
Route::get('/', function () {
    $tweeps = DB::table('tweeps')-&gt;paginate(30);
    ob_start();
?&gt;
...
&lt;?php foreach ($tweeps as $tweep): ?&gt;&lt;tr&gt;
	&lt;td&gt;&lt;?= $tweep-&gt;account ?&gt;&lt;/td&gt;
	&lt;td&gt;&lt;?= $tweep-&gt;name ?&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;?php endforeach ?&gt;
...
&lt;?php
    return ob_get_clean();
});
						</code></pre>
						<aside class="notes">
							Here's a cut down version of the controller. (Mostly to keep it
							on one screen.) I can see that the only place we generate table
							rows is based on a loop variable called $tweep, and the second
							cell is always from $tweep-&gt;name. So let's add a conditional
							breakpoint looking for part of what was in the HTML.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="strpos">
						<code class="terminal">prompt&gt; break if strpos($tweep-&gt;name, 'alert')
<span class="green">[Conditional breakpoint #1 added strpos($tweep-&gt;name, 'alert')/0x7f46430a8460]</span>
prompt&gt; continue
<span class="green">[Conditional breakpoint #1: on strpos($tweep-&gt;name, 'alert') == true at /src/app/Http/routes.php:46, hits: 1]</span>
&gt;00046:               &lt;td&gt;&lt;?= $tweep-&gt;account ?&gt;&lt;/td&gt;
 00047:               &lt;td&gt;&lt;?= $tweep-&gt;name ?&gt;&lt;/td&gt;
 00048:             &lt;/tr&gt;
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							You may remember that I said earlier that conditional breakpoints
							would accept any PHP expression. Let's use that here with strpos.
							Add the breakpoint, continue execution, and&hellip; well, that
							seems pretty damning. We're just echoing the values straight out.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="you-sneaky-hacker">
						<code class="terminal">prompt&gt; ev $tweep
stdClass Object
(
    [account] =&gt; nefarioushax0r
    [name] =&gt; &lt;script&gt;alert("I PWNED U NOOB LOLX0RZ")&lt;/script&gt;
)
						
prompt&gt; <span class="cursor"></span></code>
						<aside class="notes">
							Just to be sure, here's the $tweep variable. That name is
							definitely going to cause problems. I guess we should use a
							templating engine. Or at least call htmlspecialchars(), since PHP
							is a templating engine.
							<br>
							Now, there are limits to this approach. You can't inject
							arbitrary, non-form post data, as you can't override the
							php://input stream. You'd have to modify your front controller to
							accept post data from somewhere else. And you're reliant on how
							good the emulation is. But that's why XDebug exists.
						</aside>
					</section>
				</section>

				<section data-background="images/abacus.jpg">
					<section id="code-coverage">
						<aside class="notes">
							You can also use phpdbg as a driver for PHPUnit's code coverage.
							This has the twin advantages that you can get code coverage on
							new versions of PHP if XDebug doesn't yet support them, and also
							that phpdbg is considerably quicker.
						</aside>
					</section>

					<section data-state="translucent" data-background="translucent" id="running-phpunit">
						<code class="terminal">root@de345107bc84:/src# phpdbg -qrr vendor/bin/phpunit --color --coverage-html coverage
PHPUnit 5.3.4 by Sebastian Bergmann and contributors.

.......................                       23 / 23 (100%)

Time: 1.45 seconds, Memory: 6.00MB

<span class="green-background">OK (23 tests, 29 assertions)</span>

Generating code coverage report in HTML format ... done</code>
						<aside class="notes">
							Assuming you have a normal Composer-based setup, you can get code
							coverage by simply running phpunit under phpdbg with the right
							switches or configuration. (Explain -qrr.) Here I'm running the
							test suite for my phpdbg request faker.
						</aside>
					</section>

					<section id="coverage-results" data-background="images/coverage.png">
						<aside class="notes">
							And there are the results. Good job! Particularly on excluding
							the command directory which doesn't have integration tests
							yet&hellip;
						</aside>
					</section>
				</section>

				<section data-background="images/ide.jpg">
					<section id="ides">
						<aside class="notes">
							When I wrote the abstract for this talk, I mentioned IDE support,
							having heard of plans to implement phpdbg support in various
							IDEs. Unfortunately, as of today, there is no IDE I know of that
							implements support for phpdbg's remote protocol. PHPStorm has it
							on their roadmap, but without a version. NetBeans has an
							untriaged feature request. (Conclude on CLI, still useful, etc.)
						</aside>
					</section>
				</section>

				<section>
					<section id="xdebug">
						<a href="http://xdebug.org/">
							<img class="logo" src="images/xdebug-logo.png" alt="XDebug">
						</a>
						<aside class="notes">
							Of course, phpdbg also isn't the only game in town. There's
							XDebug. And if you have complex Web needs beyond what you can
							fake, it's still the best choice. But phpdbg is lightweight, easy
							if you're comfortable with the command line (and you should be),
							and much easier to set up. Consider it for those simple tasks!
						</aside>
					</section>
				</section>

				<section>
					<section id="questions">
						<h1>Thank you!</h1>
						<h2>Questions?</h2>
						<h3><a href="https://joind.in/talk/38764">https://joind.in/talk/38764</a></h3>
						<h3><a href="https://twitter.com/LGnome">@LGnome</a><h3>
						<p>
							Slides:
							<a href="https://lawngnome.github.io/phpdbg-for-fun-and-profit/">
								https://lawngnome.github.io/phpdbg-for-fun-and-profit/
							</a>
						</p>
					</section>

					<section id="image-credits">
						<h2>Image credits</h2>
						<div></div>
					</section>
				</section>
			</div>
		</div>

		<script src="reveal.js/lib/js/head.min.js"></script>
		<script src="reveal.js/js/reveal.js"></script>

		<script src="js/jquery-2.2.4.min.js"></script>
		<script src="js/images.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: (-1 == window.location.host.indexOf("localhost") && -1 == window.location.host.indexOf("0.0.0.0")),
				progress: false,
				history: true,
				center: true,
				width: 1280,
				height: 800,

				transition: 'fade', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'reveal.js/plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
					{ src: 'reveal.js/plugin/notes/notes.js', async: true }
				]
			});

			$("#image-credits > div").imageCredits();

		</script>
	</body>
</html>
<!-- vim: set nocin ai noet ts=2 sw=2: -->
